<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="LIKE E-Gift Cards - Buy Gift Vouchers online for Birthdays, Weddings & More from popular brands. Low Prices, Best Deals, Great Offers." />
  <meta name="keywords" content="gift cards, e-gift cards, vouchers, online gifts, LIKE" />
  <title>LIKE ‚Äî Gift Card Creator & Redemption</title>
  <style>
    :root{--bg:#0f2540;--accent:#ff8a00;--card:#ffffff;--muted:#98a0b3}
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,system-ui,Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#07122b 0%,#0f2540 100%);color:#fff;padding:32px}
    .container{width:100%;max-width:1200px;margin:0 auto}
    
    .tabs{display:flex;gap:8px;margin-bottom:24px;background:rgba(255,255,255,0.02);padding:8px;border-radius:12px}
    .tab{padding:12px 24px;border-radius:8px;border:0;background:transparent;color:#fff;cursor:pointer;font-weight:600;transition:all 0.3s}
    .tab:hover{background:rgba(255,255,255,0.05)}
    .tab.active{background:var(--accent);color:#081222}
    
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .app{width:100%;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border-radius:16px;padding:28px;display:grid;grid-template-columns:1fr 420px;gap:24px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    
    .redeem-section{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border-radius:16px;padding:28px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    
    header{grid-column:1/-1;display:flex;align-items:center;gap:16px;margin-bottom:16px}
    .logo{width:64px;height:64px;border-radius:50%;overflow:hidden;flex:0 0 64px;background:#fff;display:flex;align-items:center;justify-content:center}
    .logo img{width:100%;height:100%;object-fit:cover}
    h1{font-size:20px;margin:0}
    h2{font-size:24px;margin:0 0 20px 0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{padding:18px;background:rgba(255,255,255,0.02);border-radius:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input[type=text],input[type=email],input[type=number],textarea,select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.05);color:#fff;margin-top:6px;font-size:14px}
    select{background:#ff8a00;color:#000}
    select option{background:#ff8a00;color:#000}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px}
    .row > *{flex:1}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#081222;font-weight:600;cursor:pointer;margin-top:14px;transition:transform 0.2s,opacity 0.2s}
    .btn:hover{transform:translateY(-2px);opacity:0.9}
    .btn:active{transform:translateY(0)}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .btn.full{width:100%}
    
    .preview{padding:18px;background:linear-gradient(180deg,#071a33, #08314f);border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:12px}

    .card-mock{width:360px;height:200px;border-radius:12px;background:linear-gradient(90deg,#0b355b,#093b6d);position:relative;padding:18px;color:#fff;box-shadow:0 8px 30px rgba(2,6,23,0.6);transition:transform 0.3s}
    .card-mock:hover{transform:scale(1.02)}
    .card-top{display:flex;align-items:center;justify-content:space-between}
    .card-brand{display:flex;align-items:center;gap:10px}
    .card-brand img{width:56px;height:56px;border-radius:50%;background:#fff;padding:3px}
    .card-value{font-size:22px;font-weight:700}
    .card-code{position:absolute;left:18px;bottom:18px;font-family:monospace;background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:6px;font-size:13px}
    .muted{color:var(--muted);font-size:13px}

    .small{font-size:13px}
    .success-msg{background:rgba(0,200,83,0.1);border:1px solid rgba(0,200,83,0.3);color:#00c853;padding:8px 12px;border-radius:8px;margin-top:8px;font-size:13px;display:none}
    .success-msg.show{display:block;animation:slideIn 0.3s}
    .error-msg{background:rgba(255,59,48,0.1);border:1px solid rgba(255,59,48,0.3);color:#ff3b30;padding:8px 12px;border-radius:8px;margin-top:8px;font-size:13px;display:none}
    .error-msg.show{display:block;animation:slideIn 0.3s}
    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    
    .info-box{background:rgba(255,138,0,0.1);border:1px solid rgba(255,138,0,0.3);padding:16px;border-radius:8px;margin:16px 0}
    .info-box h3{margin:0 0 8px 0;font-size:16px;color:var(--accent)}
    
    .payment-details{background:rgba(255,255,255,0.02);padding:16px;border-radius:8px;margin-top:12px;display:none}
    .payment-details.show{display:block}
    
    .redeem-result{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;margin-top:16px;display:none}
    .redeem-result.show{display:block}
    
    footer{text-align:center;color:var(--muted);font-size:13px;margin-top:20px}

    @media (max-width:920px){
      .app{grid-template-columns:1fr;max-width:720px}
      .preview{order:2}
      .tabs{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tabs">
      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

      <button class="tab active" onclick="switchTab('create')">Create Gift Card</button>
      <button class="tab" onclick="switchTab('redeem')">Redeem Gift Card</button>
    </div>

    <!-- CREATE GIFT CARD TAB -->
    <div id="createTab" class="tab-content active">
      <div class="app">
        <header>
          <div class="logo"><img src="https://turquoise-reasonable-penguin-388.mypinata.cloud/ipfs/bafkreiconcyyp3447jlcrmsmil6w3punwvyvoxqkzqh76uq22u5ms34amq" alt="LIKE logo" /></div>
          <div>
            <h1>LIKE‚ù§Ô∏è E-Gift Cards</h1>
            <p class="lead">Buy Gift Vouchers online for Birthdays, Weddings & More from popular brands. Low Prices, Best Deals, Great Offers, Huge Selection.</p>
          </div>
        </header>

        <section class="controls">
          <label>Recipient name</label>
          <input id="recipient" type="text" placeholder="Recipient name (optional)" />

          <div class="row">
            <div>
              <label>Recipient Email</label>
              <input id="recipientEmail" type="email" placeholder="recipient@example.com (optional)" />
            </div>
            <div>
              <label>Your Email *</label>
              <input id="senderEmail" type="email" placeholder="your@example.com" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Amount</label>
              <input id="amount" type="number" min="1" value="50" />
            </div>
            <div>
              <label>Currency</label>
              <select id="currency">
                <option value="Ô∑º ">SAR Ô∑º</option>
                <option value="$ ">USD $</option>
                <option value="‚Ç¨ ">EUR ‚Ç¨</option>
                <option value="ÿØ.ÿ• ">AED ÿØ.ÿ•</option>
                <option value="‚Çπ " selected>INR ‚Çπ</option>
              </select>
            </div>
          </div>

          <label>Personal message</label>
          <textarea id="message" placeholder="Add a short message (optional)"></textarea>

          <label>Denomination type</label>
          <select id="denomType">
            <option value="fixed">Fixed (single use)</option>
            <option value="multi">Multi-use / Balance</option>
          </select>

          <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
            <button class="btn" id="generateBtn">Generate Gift Card</button>
            <button class="btn secondary" id="resetBtn">Reset</button>
          </div>

          <div style="margin-top:12px">
            <label class="small">E-Gift card Code</label>
            <input id="code" type="text" readonly placeholder="Generated code will appear here" />
          </div>

          <div id="successMsg" class="success-msg">‚úì Code copied to clipboard!</div>
          <div id="errorMsg" class="error-msg">‚úó Please fix the errors above</div>

          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="copyBtn">Copy Code</button>
            <button class="btn" id="downloadBtn">Download PNG</button>
            <button class="btn" id="emailBtn">Send via Email</button>
          </div>

        </section>

        <aside class="preview">
          <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="muted">Preview</div>
              <div style="font-weight:700">Digital + Printable</div>
            </div>
            <div class="small">Website: <strong>LIKE</strong></div>
          </div>

          <div id="cardArea" class="card-mock" role="img" aria-label="Gift card preview">
            <div class="card-top">
              <div class="card-brand">
                <img id="logoPreview" src="https://turquoise-reasonable-penguin-388.mypinata.cloud/ipfs/bafkreiconcyyp3447jlcrmsmil6w3punwvyvoxqkzqh76uq22u5ms34amq" alt="LIKE logo" />
                <div>
                  <div style="font-size:14px;font-weight:700">LIKE</div>
                  <div class="muted small">Gift Card</div>
                </div>
              </div>
              <div class="card-value"><span id="currencyPreview">‚Çπ</span><span id="amountPreview">50</span></div>
            </div>
            <div style="margin-top:18px;color:rgba(255,255,255,0.9)" id="messagePreview">A special gift for you!</div>
            <div class="card-code" id="codePreview">LIKE-XXXX-XXXX</div>
          </div>

          <canvas id="exportCanvas" width="900" height="500" style="display:none"></canvas>

          <div style="width:100%;display:flex;gap:8px;justify-content:center;margin-top:8px;flex-wrap:wrap">
            <button class="btn secondary" id="saveTemplate">Save Template</button>
            <button class="btn secondary" id="loadTemplate">Load Template</button>
          </div>

          <div style="font-size:12px;color:var(--muted);margin-top:8px;text-align:center">Tip: Use the Download PNG button to save a printable image of the gift card for better convenience.</div>
        </aside>
      </div>
    </div>

    <!-- REDEEM GIFT CARD TAB -->
    <div id="redeemTab" class="tab-content">
      <div class="redeem-section">
        <header style="display:block">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
            <div class="logo"><img src="https://turquoise-reasonable-penguin-388.mypinata.cloud/ipfs/bafkreiconcyyp3447jlcrmsmil6w3punwvyvoxqkzqh76uq22u5ms34amq" alt="LIKE logo" /></div>
            <div>
              <h2>Redeem Your Gift Card</h2>
              <p class="lead">Enter your gift card code to redeem and withdraw funds to your preferred payment method.</p>
            </div>
          </div>
        </header>

        <div class="info-box">
          <h3>How to Redeem</h3>
          <p class="small">1. Enter your gift card code below<br>2. Verify the amount<br>3. Choose your withdrawal method (Bank or Crypto)<br>4. Submit your redemption request</p>
        </div>

        <div class="controls">
          <label>Gift Card Code *</label>
          <input id="redeemCode" type="text" placeholder="LIKE-XXXX-XXXX-XXXX" />

          <button class="btn full" id="verifyBtn">Verify Gift Card</button>

          <div id="redeemSuccessMsg" class="success-msg">‚úì Gift card verified!</div>
          <div id="redeemErrorMsg" class="error-msg">‚úó Invalid gift card code</div>

          <div id="redeemDetails" class="redeem-result">
            <h3 style="margin:0 0 12px 0">Gift Card Details</h3>
            <div style="display:grid;gap:8px">
              <div style="display:flex;justify-content:space-between">
                <span class="muted">Card Code:</span>
                <strong id="verifiedCode">-</strong>
              </div>
              <div style="display:flex;justify-content:space-between">
                <span class="muted">Amount:</span>
                <strong id="verifiedAmount">-</strong>
              </div>
              <div style="display:flex;justify-content:space-between">
                <span class="muted">Currency:</span>
                <strong id="verifiedCurrency">-</strong>
              </div>
              <div style="display:flex;justify-content:space-between">
                <span class="muted">Status:</span>
                <strong style="color:#00c853" id="verifiedStatus">Active</strong>
              </div>
            </div>

            <label style="margin-top:20px">Withdrawal Method *</label>
            <select id="withdrawalMethod" onchange="showPaymentOptions()">
              <option value="">-- Select Method --</option>
              <option value="bank">Bank Transfer</option>
              <option value="crypto">Cryptocurrency</option>
            </select>

            <!-- BANK TRANSFER OPTIONS -->
            <div id="bankOptions" class="payment-details">
              <label>Select Your Bank *</label>
              <select id="bankSelect">
                <option value="">-- Select Bank --</option>
              </select>

              <label>Account Holder Name *</label>
              <input id="accountName" type="text" placeholder="Full name as per bank account" />

              <label>Account Number / IBAN *</label>
              <input id="accountNumber" type="text" placeholder="Enter your account number" />

              <label>Swift/BIC Code (if international)</label>
              <input id="swiftCode" type="text" placeholder="Optional for international transfers" />
            </div>

            <!-- CRYPTO OPTIONS -->
            <div id="cryptoOptions" class="payment-details">
              <label>Crypto Network *</label>
              <select id="cryptoNetwork">
                <option value="">-- Select Network --</option>
                <option value="usdt-bep20">USDT (BEP20 - Binance Smart Chain)</option>
                <option value="usdt-trc20">USDT (TRC20 - Tron)</option>
              </select>

              <label>Wallet Address *</label>
              <input id="walletAddress" type="text" placeholder="Enter your wallet address" />

              <div style="background:rgba(255,59,48,0.1);border:1px solid rgba(255,59,48,0.3);padding:12px;border-radius:8px;margin-top:8px">
                <p class="small" style="margin:0;color:#ff3b30">‚ö†Ô∏è Warning: Double-check your wallet address. Cryptocurrency transactions are irreversible!</p>
              </div>
            </div>

            <label style="margin-top:16px">Email for Confirmation *</label>
            <input id="redeemEmail" type="email" placeholder="your@example.com" />

            <button class="btn full" id="submitRedeemBtn">Submit Redemption Request</button>
          </div>
        </div>
      </div>
    </div>

    <footer>Built with ‚ù§Ô∏è for LIKE ‚Äî We simplify your needs.</footer>
  </div>

<script>
// ========================================
// üîß API CONFIGURATION - UPDATE THIS URL!
// ========================================
const API_URL = 'https://like-giftcards-api.onrender.com/api';
  const RAZORPAY_KEY = "rzp_test_Rt6rTO0QIYWaVk";

// ‚¨ÜÔ∏è Replace with YOUR actual Render URL after deployment

// ========================================
// HELPER FUNCTIONS
// ========================================

// API Call Helper
async function apiCall(endpoint, method = 'GET', data = null) {
  try {
    const options = {
      method,
      headers: { 'Content-Type': 'application/json' }
    };
    if (data) options.body = JSON.stringify(data);
    
    const response = await fetch(`${API_URL}${endpoint}`, options);
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.message || 'Request failed');
    }
    return result;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

// Email Validation
function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tab + 'Tab').classList.add('active');
}

// Bank lists
const banks = {
  'SAR': [
    'Saudi National Bank (SNB)',
    'Al Rajhi Bank',
    'Riyad Bank',
    'Saudi Awwal Bank',
    'Banque Saudi Fransi',
    'Arab National Bank (ANB)'
  ],
  'AED': [
    'First Abu Dhabi Bank (FAB)',
    'Emirates NBD',
    'Abu Dhabi Commercial Bank (ADCB)',
    'Commercial Bank of Dubai (CBD)',
    'Mashreq Bank'
  ],
  'INR': [
    'State Bank of India (SBI)',
    'HDFC Bank',
    'ICICI Bank',
    'Axis Bank',
    'Punjab National Bank'
  ],
  'USD': [
    'Bank of America',
    'JPMorgan Chase',
    'Wells Fargo',
    'Citibank',
    'US Bank'
  ],
  'EUR': [
    'Deutsche Bank',
    'BNP Paribas',
    'Soci√©t√© G√©n√©rale',
    'ING Bank',
    'Santander'
  ]
};

// ========================================
// DOM ELEMENTS
// ========================================
const recipient = document.getElementById('recipient');
const recipientEmail = document.getElementById('recipientEmail');
const senderEmail = document.getElementById('senderEmail');
const amount = document.getElementById('amount');
const currency = document.getElementById('currency');
const message = document.getElementById('message');
const generateBtn = document.getElementById('generateBtn');
const resetBtn = document.getElementById('resetBtn');
const codeField = document.getElementById('code');
const codePreview = document.getElementById('codePreview');
const amountPreview = document.getElementById('amountPreview');
const currencyPreview = document.getElementById('currencyPreview');
const messagePreview = document.getElementById('messagePreview');
const downloadBtn = document.getElementById('downloadBtn');
const copyBtn = document.getElementById('copyBtn');
const emailBtn = document.getElementById('emailBtn');
const saveTemplate = document.getElementById('saveTemplate');
const loadTemplate = document.getElementById('loadTemplate');
const successMsg = document.getElementById('successMsg');
const errorMsg = document.getElementById('errorMsg');

// ========================================
// DISPLAY FUNCTIONS
// ========================================
function updatePreview(){
  amountPreview.textContent = amount.value || '0';
  const currSymbol = currency.value || '‚Çπ ';
  currencyPreview.textContent = currSymbol;
  messagePreview.textContent = message.value || 'A special gift for you!';
}

function showSuccess(msg = '‚úì Code copied to clipboard!'){
  successMsg.textContent = msg;
  successMsg.classList.add('show');
  errorMsg.classList.remove('show');
  setTimeout(() => {
    successMsg.classList.remove('show');
  }, 3000);
}

function showError(msg = '‚úó Please fix the errors above'){
  errorMsg.textContent = msg;
  errorMsg.classList.add('show');
  successMsg.classList.remove('show');
  setTimeout(() => {
    errorMsg.classList.remove('show');
  }, 3000);
}

// ========================================
// CREATE GIFT CARD - UPDATED WITH API
// ========================================
generateBtn.addEventListener('click', async () => {
  try {
    // ‚úÖ Validation
    if (!senderEmail.value || !validateEmail(senderEmail.value)) {
      showError('‚úó Please enter a valid sender email');
      return;
    }

    if (!amount.value || amount.value < 1) {
      showError('‚úó Please enter a valid amount');
      return;
    }

    generateBtn.disabled = true;
    generateBtn.textContent = 'Redirecting to payment...';

    // ‚úÖ CREATE RAZORPAY ORDER
    const orderRes = await fetch(
      `${API_URL}/razorpay/create-order`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: amount.value,
          email: senderEmail.value
        })
      }
    );

    const order = await orderRes.json();

    // ‚úÖ OPEN RAZORPAY
    const options = {
      method: {
  upi: true,
  card: true,
  netbanking: true,
  wallet: false
}

      key: RAZORPAY_KEY,
      amount: order.amount,
      currency: "INR",
      name: "LIKE Gift Cards",
      description: "Gift Card Purchase",
      order_id: order.id,
      

      handler: async function (response) {
        // ‚úÖ VERIFY PAYMENT
        const verifyRes = await fetch(
          `${API_URL}/razorpay/verify`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ...response,
              recipient: recipient.value,
              recipientEmail: recipientEmail.value,
              senderEmail: senderEmail.value,
              amount: amount.value,
              currency: currency.options[currency.selectedIndex].text,
              currencySymbol: currency.value,
              message: message.value,
              denomType: document.getElementById('denomType').value
            })
          }
        );

        const result = await verifyRes.json();

        if (result.success) {
          codeField.value = result.code;
          codePreview.textContent = result.code;
          updatePreview();
          showSuccess('‚úì Payment successful! Gift card created.');
        } else {
          showError('‚úó Payment verification failed');
        }
      },

      theme: { color: "#ff8a00" }
    };

    new Razorpay(options).open();

  } catch (err) {
    console.error(err);
    showError('‚úó Payment failed');
  } finally {
    generateBtn.disabled = false;
    generateBtn.textContent = 'Generate Gift Card';
  }
});


// ========================================
// RESET BUTTON
// ========================================
resetBtn.addEventListener('click', ()=>{
  recipient.value=''; 
  recipientEmail.value='';
  senderEmail.value='';
  amount.value = 50; 
  currency.value='‚Çπ '; 
  message.value=''; 
  codeField.value=''; 
  codePreview.textContent='LIKE-XXXX-XXXX'; 
  updatePreview();
});

// ========================================
// COPY CODE BUTTON
// ========================================
copyBtn.addEventListener('click', ()=>{
  if(!codeField.value){ 
    alert('Generate a code first.'); 
    return; 
  }
  navigator.clipboard.writeText(codeField.value).then(()=>{
    showSuccess('‚úì Code copied to clipboard!');
  }).catch(()=>{ 
    alert('Could not copy ‚Äî please copy manually.'); 
  });
});

// ========================================
// CANVAS DRAWING (for PNG download)
// ========================================
async function drawCardToCanvas(){
  const canvas = document.getElementById('exportCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 1200; 
  canvas.height = 700;
  
  const grad = ctx.createLinearGradient(0,0,canvas.width,0);
  grad.addColorStop(0,'#0b355b'); 
  grad.addColorStop(1,'#093b6d');
  ctx.fillStyle = grad; 
  ctx.fillRect(0,0,canvas.width,canvas.height);
  
  const logoImg = new Image();
  logoImg.crossOrigin = 'anonymous';
  logoImg.src = 'https://turquoise-reasonable-penguin-388.mypinata.cloud/ipfs/bafkreiconcyyp3447jlcrmsmil6w3punwvyvoxqkzqh76uq22u5ms34amq';
  
  return new Promise((res,rej)=>{
    logoImg.onload = ()=>{
      const lgSize = 160;
      ctx.save();
      ctx.beginPath(); 
      ctx.arc(60+lgSize/2, 60+lgSize/2, lgSize/2, 0, Math.PI*2); 
      ctx.closePath(); 
      ctx.clip();
      ctx.drawImage(logoImg, 60, 60, lgSize, lgSize);
      ctx.restore();
      
      ctx.fillStyle='#fff'; 
      ctx.font='bold 48px sans-serif'; 
      ctx.fillText('LIKE', 60+lgSize+28, 60+60);
      ctx.font='24px sans-serif'; 
      ctx.fillStyle='rgba(255,255,255,0.9)'; 
      ctx.fillText('Gift Card', 60+lgSize+28, 60+100);
      
      ctx.font='bold 72px sans-serif'; 
      ctx.fillStyle='#fff'; 
      ctx.fillText((currency.value||'‚Çπ ')+ (amount.value||'0'), canvas.width - 420, 160);
      
      ctx.font='24px sans-serif'; 
      ctx.fillStyle='rgba(255,255,255,0.95)'; 
      const msg = message.value || 'A special gift for you!';
      ctx.fillText(msg, 60, 260);
      
      ctx.fillStyle='rgba(255,255,255,0.08)'; 
      ctx.fillRect(60, 320, 480, 60);
      ctx.font='26px monospace'; 
      ctx.fillStyle='#fff'; 
      ctx.fillText(codeField.value || 'LIKE-XXXX-XXXX', 78, 360);
      
      res(canvas.toDataURL('image/png'));
    };
    logoImg.onerror = ()=> rej(new Error('Logo load failed'));
  });
}

// ========================================
// DOWNLOAD PNG BUTTON
// ========================================
downloadBtn.addEventListener('click', async ()=>{
  if(!codeField.value){ 
    alert('Generate a card first.'); 
    return; 
  }
  try{
    const dataUrl = await drawCardToCanvas();
    const a = document.createElement('a'); 
    a.href = dataUrl; 
    a.download = (codeField.value || 'like-giftcard') + '.png';
    document.body.appendChild(a); 
    a.click(); 
    a.remove();
  }catch(e){ 
    alert('Could not generate image: '+e.message); 
  }
});

// ========================================
// EMAIL BUTTON (opens mailto)
// ========================================
emailBtn.addEventListener('click', async ()=>{
  if(!codeField.value){ 
    showError('‚úó Please generate a gift card first');
    return; 
  }
  
  if(!senderEmail.value || !validateEmail(senderEmail.value)){
    showError('‚úó Please enter a valid email address');
    senderEmail.focus();
    return;
  }

  if(recipientEmail.value && !validateEmail(recipientEmail.value)){
    showError('‚úó Recipient email is invalid');
    recipientEmail.focus();
    return;
  }

  try{
    const recipientName = recipient.value || 'Valued Customer';
    const giftMessage = message.value || 'A special gift for you!';
    const cardAmount = currency.value + amount.value;
    
    const subject = encodeURIComponent(`Your LIKE Gift Card - ${cardAmount}`);
    const body = encodeURIComponent(
      `Hi ${recipientName},\n\n` +
      `You have received a LIKE E-Gift Card!\n\n` +
      `Gift Card Code: ${codeField.value}\n` +
      `Amount: ${cardAmount}\n` +
      `Message: ${giftMessage}\n\n` +
      `To redeem your gift card, visit https://hungryhawk87.github.io/linkegiftcard.github.io/ and enter your code.\n\n` +
      `Thank you for choosing LIKE!\n\n` +
      `---\n` +
      `This gift card was sent from: ${senderEmail.value}\n` +
      `${recipientEmail.value ? 'Sent to: ' + recipientEmail.value : ''}`
    );
    
    const mailtoLink = `mailto:${recipientEmail.value || senderEmail.value}?subject=${subject}&body=${body}`;
    window.location.href = mailtoLink;
    
    showSuccess('‚úì Email client opened! Please attach the downloaded PNG image.');
    
    setTimeout(async () => {
      try{
        const dataUrl = await drawCardToCanvas();
        const a = document.createElement('a'); 
        a.href = dataUrl; 
        a.download = (codeField.value || 'like-giftcard') + '.png';
        document.body.appendChild(a); 
        a.click(); 
        a.remove();
      }catch(e){
        console.error('Auto-download failed:', e);
      }
    }, 500);
    
  }catch(e){ 
    showError('‚úó Could not prepare email: ' + e.message);
  }
});

// ========================================
// SAVE/LOAD TEMPLATE (uses localStorage for templates only)
// ========================================
saveTemplate.addEventListener('click', ()=>{
  const template = {
    amount: amount.value, 
    currency: currency.value, 
    message: message.value,
    senderEmail: senderEmail.value
  };
  try {
    localStorage.setItem('like_gift_template', JSON.stringify(template));
    showSuccess('‚úì Template saved!');
  } catch(e) {
    showError('‚úó Could not save template');
  }
});

loadTemplate.addEventListener('click', ()=>{
  try {
    const t = localStorage.getItem('like_gift_template');
    if(!t){ 
      showError('‚úó No template found');
      return; 
    }
    const parsed = JSON.parse(t); 
    amount.value = parsed.amount || 50; 
    currency.value = parsed.currency || '‚Çπ '; 
    message.value = parsed.message || ''; 
    senderEmail.value = parsed.senderEmail || '';
    updatePreview();
    showSuccess('‚úì Template loaded!');
  } catch(e) {
    showError('‚úó Could not load template');
  }
});

// Initialize create section
updatePreview();
amount.addEventListener('input', updatePreview); 
currency.addEventListener('change', updatePreview); 
message.addEventListener('input', updatePreview);

// ========================================
// REDEEM SECTION
// ========================================
const redeemCode = document.getElementById('redeemCode');
const verifyBtn = document.getElementById('verifyBtn');
const redeemDetails = document.getElementById('redeemDetails');
const redeemSuccessMsg = document.getElementById('redeemSuccessMsg');
const redeemErrorMsg = document.getElementById('redeemErrorMsg');
const withdrawalMethod = document.getElementById('withdrawalMethod');
const bankOptions = document.getElementById('bankOptions');
const cryptoOptions = document.getElementById('cryptoOptions');
const bankSelect = document.getElementById('bankSelect');
const submitRedeemBtn = document.getElementById('submitRedeemBtn');

function showRedeemSuccess(msg){
  redeemSuccessMsg.textContent = msg;
  redeemSuccessMsg.classList.add('show');
  redeemErrorMsg.classList.remove('show');
  setTimeout(() => {
    redeemSuccessMsg.classList.remove('show');
  }, 3000);
}

function showRedeemError(msg){
  redeemErrorMsg.textContent = msg;
  redeemErrorMsg.classList.add('show');
  redeemSuccessMsg.classList.remove('show');
  setTimeout(() => {
    redeemErrorMsg.classList.remove('show');
  }, 3000);
}

// ========================================
// VERIFY GIFT CARD - UPDATED WITH API
// ========================================
verifyBtn.addEventListener('click', async () => {
  try {
    const code = redeemCode.value.trim().toUpperCase();
    
    if (!code) {
      showRedeemError('‚úó Please enter a gift card code');
      return;
    }
    
    // Show loading
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'Verifying...';
    
    // Call API
    const result = await apiCall('/giftcards/verify', 'POST', { code });
    
    if (result.success) {
      const card = result.data;
      
      // Update UI
      document.getElementById('verifiedCode').textContent = card.code;
      document.getElementById('verifiedAmount').textContent = card.amount;
      document.getElementById('verifiedCurrency').textContent = card.currencySymbol || card.currency;
      
      const statusEl = document.getElementById('verifiedStatus');
      statusEl.textContent = card.status.charAt(0).toUpperCase() + card.status.slice(1);
      statusEl.style.color = card.status === 'active' ? '#00c853' : '#ff3b30';
      
      if (card.status === 'active') {
        redeemDetails.classList.add('show');
        showRedeemSuccess('‚úì Gift card verified successfully!');
        
        // Update bank list based on currency
        updateBankListFromCurrency(card.currency);
      } else {
        redeemDetails.classList.remove('show');
        showRedeemError(`‚úó Gift card is ${card.status}`);
      }
    }
    
  } catch (error) {
    redeemDetails.classList.remove('show');
    showRedeemError('‚úó ' + error.message);
  } finally {
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'Verify Gift Card';
  }
});

// ========================================
// PAYMENT OPTIONS TOGGLE
// ========================================
  
function showPaymentOptions(){
  const method = withdrawalMethod.value;
  
  bankOptions.classList.remove('show');
  cryptoOptions.classList.remove('show');
  
  if(method === 'bank'){
    bankOptions.classList.add('show');
  } else if(method === 'crypto'){
    cryptoOptions.classList.add('show');
  }
}

// ========================================
// UPDATE BANK LIST BASED ON CURRENCY
// ========================================
function updateBankListFromCurrency(currencyStr) {
  let currencyCode = 'SAR';
  
  if (currencyStr.includes('SAR') || currencyStr.includes('Ô∑º')) currencyCode = 'SAR';
  else if (currencyStr.includes('USD') || currencyStr.includes('$')) currencyCode = 'USD';
  else if (currencyStr.includes('EUR') || currencyStr.includes('‚Ç¨')) currencyCode = 'EUR';
  else if (currencyStr.includes('AED') || currencyStr.includes('ÿØ.ÿ•')) currencyCode = 'AED';
  else if (currencyStr.includes('INR') || currencyStr.includes('‚Çπ')) currencyCode = 'INR';
  
  const bankList = banks[currencyCode] || banks['SAR'];
  
  bankSelect.innerHTML = '<option value="">-- Select Bank --</option>';
  bankList.forEach(bank => {
    const option = document.createElement('option');
    option.value = bank;
    option.textContent = bank;
    bankSelect.appendChild(option);
  });
}

// ========================================
// SUBMIT REDEMPTION - UPDATED WITH API
// ========================================
submitRedeemBtn.addEventListener('click', async () => {
  try {
    const code = redeemCode.value.trim().toUpperCase();
    const method = withdrawalMethod.value;
    const email = document.getElementById('redeemEmail').value;
    
    // Validation
    if (!code) {
      showRedeemError('‚úó Invalid gift card code');
      return;
    }
    
    if (!method) {
      showRedeemError('‚úó Please select a withdrawal method');
      return;
    }
    
    if (!email || !validateEmail(email)) {
      showRedeemError('‚úó Please enter a valid email');
      return;
    }
    
    let requestData = {
      code,
      withdrawalMethod: method,
      email
    };
    
    // Bank transfer validation
    if (method === 'bank') {
      const bank = bankSelect.value;
      const accName = document.getElementById('accountName').value;
      const accNum = document.getElementById('accountNumber').value;
      
      if (!bank || !accName || !accNum) {
        showRedeemError('‚úó Please fill in all bank details');
        return;
      }
      
      requestData.bankName = bank;
      requestData.accountName = accName;
      requestData.accountNumber = accNum;
      requestData.swiftCode = document.getElementById('swiftCode').value;
    }
    
    // Crypto validation
    if (method === 'crypto') {
      const network = document.getElementById('cryptoNetwork').value;
      const wallet = document.getElementById('walletAddress').value;
      
      if (!network || !wallet) {
        showRedeemError('‚úó Please fill in all crypto details');
        return;
      }
      
      if (wallet.length < 26) {
        showRedeemError('‚úó Invalid wallet address');
        return;
      }
      
      requestData.cryptoNetwork = network;
      requestData.walletAddress = wallet;
    }
    
    // Show loading
    submitRedeemBtn.disabled = true;
    submitRedeemBtn.textContent = 'Processing...';
    
    // Call API
    const result = await apiCall('/giftcards/redeem', 'POST', requestData);
    
    if (result.success) {
      document.getElementById('verifiedStatus').textContent = 'Redeemed';
      document.getElementById('verifiedStatus').style.color = '#ff3b30';
      
      showRedeemSuccess('‚úì Redemption successful! Check your email for confirmation.');
      
      // Reset form after 3 seconds
      setTimeout(() => {
        redeemCode.value = '';
        redeemDetails.classList.remove('show');
        withdrawalMethod.value = '';
        document.getElementById('redeemEmail').value = '';
        bankOptions.classList.remove('show');
        cryptoOptions.classList.remove('show');
        document.getElementById('accountName').value = '';
        document.getElementById('accountNumber').value = '';
        document.getElementById('swiftCode').value = '';
        document.getElementById('cryptoNetwork').value = '';
        document.getElementById('walletAddress').value = '';
      }, 3000);
    }
    
  } catch (error) {
    showRedeemError('‚úó ' + error.message);
  } finally {
    submitRedeemBtn.disabled = false;
    submitRedeemBtn.textContent = 'Submit Redemption Request';
  }
});

// ========================================
// LOG API CONNECTION
// ========================================
console.log('‚úì Frontend connected to API:', API_URL);
console.log('‚úì LIKE Gift Cards system ready!');
</script>
</body>
</html>
